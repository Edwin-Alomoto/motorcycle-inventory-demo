<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Inicialización Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4><i class="fas fa-cog me-2"></i>Test - Inicialización del Dashboard</h4>
                    </div>
                    <div class="card-body">
                        <p>Esta página verifica que el dashboard se inicialice correctamente.</p>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Instrucciones:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Revisa la consola del navegador para ver los logs de inicialización</li>
                                <li>Haz clic en "Verificar Estado" para comprobar el estado actual</li>
                                <li>Haz clic en "Probar Edición" para probar la funcionalidad</li>
                            </ul>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <button class="btn btn-info mb-3" onclick="verificarEstado()">
                                    <i class="fas fa-check me-2"></i>Verificar Estado
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-success mb-3" onclick="cargarProductoPrueba()">
                                    <i class="fas fa-plus me-2"></i>Cargar Producto
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary mb-3" onclick="probarEdicion()">
                                    <i class="fas fa-edit me-2"></i>Probar Edición
                                </button>
                            </div>
                        </div>
                        
                        <div id="estadoInfo" class="alert alert-secondary">
                            <i class="fas fa-clock me-2"></i>
                            Estado: Esperando verificación...
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Código</th>
                                        <th>Nombre</th>
                                        <th>Precio</th>
                                        <th>Stock</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="productosTable">
                                    <!-- Se llenará dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Producto -->
    <div class="modal fade" id="productoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productoForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="codigoProducto" class="form-label">Código</label>
                                    <input type="text" class="form-control" id="codigoProducto" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="nombreProducto" class="form-label">Nombre</label>
                                    <input type="text" class="form-control" id="nombreProducto" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="descripcionProducto" class="form-label">Descripción</label>
                            <textarea class="form-control" id="descripcionProducto" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="codigoQRProducto" class="form-label">Código QR</label>
                                    <input type="text" class="form-control" id="codigoQRProducto" placeholder="Ingrese el código QR del producto">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Vista Previa QR</label>
                                    <div id="qrPreview" class="border rounded p-2 text-center" style="min-height: 120px; background-color: #f8f9fa;">
                                        <!-- El QR por defecto se generará automáticamente -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="precioProducto" class="form-label">Precio</label>
                                    <input type="number" class="form-control" id="precioProducto" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="descuentoMinimoProducto" class="form-label">Descuento Mínimo (%)</label>
                                    <input type="number" class="form-control" id="descuentoMinimoProducto" step="0.1" value="0" min="0" max="100">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="descuentoMaximoProducto" class="form-label">Descuento Máximo (%)</label>
                                    <input type="number" class="form-control" id="descuentoMaximoProducto" step="0.1" value="0" min="0" max="100">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="stockProducto" class="form-label">Stock Actual</label>
                                    <input type="number" class="form-control" id="stockProducto" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="stockMinimoProducto" class="form-label">Stock Mínimo</label>
                                    <input type="number" class="form-control" id="stockMinimoProducto" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="stockMaximoProducto" class="form-label">Stock Máximo</label>
                                    <input type="number" class="form-control" id="stockMaximoProducto" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="proveedorProducto" class="form-label">Proveedor</label>
                                    <select class="form-select" id="proveedorProducto" required>
                                        <option value="">Seleccionar proveedor</option>
                                        <option value="Proveedor A">Proveedor A</option>
                                        <option value="Proveedor B">Proveedor B</option>
                                        <option value="Proveedor C">Proveedor C</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarProducto()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/admin-dashboard.js"></script>
    
    <script>
        // Producto de prueba
        const productoPrueba = {
            id: 'prod-test-init-001',
            codigo: 'MOTO-TEST-INIT-001',
            nombre: 'Honda CBR 600RR Test Init',
            descripcion: 'Motocicleta deportiva para prueba de inicialización',
            precio: 15000,
            stock: 5,
            stockMinimo: 2,
            stockMaximo: 20,
            proveedor: 'Proveedor A',
            descuentoMinimo: 5,
            descuentoMaximo: 15,
            codigoQR: 'HONDA-CBR600RR-TEST-INIT'
        };
        
        // Función para verificar el estado del dashboard
        function verificarEstado() {
            const estadoInfo = document.getElementById('estadoInfo');
            let estadoHTML = '<i class="fas fa-info-circle me-2"></i><strong>Estado del Dashboard:</strong><br>';
            
            // Verificar si adminDashboard está disponible
            if (window.adminDashboard) {
                estadoHTML += '<span class="text-success">✓ adminDashboard está disponible</span><br>';
                
                // Verificar métodos específicos
                const metodos = ['editarProducto', 'eliminarProducto', 'loadProductos', 'showNotification'];
                metodos.forEach(metodo => {
                    if (typeof window.adminDashboard[metodo] === 'function') {
                        estadoHTML += `<span class="text-success">✓ Método ${metodo} disponible</span><br>`;
                    } else {
                        estadoHTML += `<span class="text-danger">✗ Método ${metodo} NO disponible</span><br>`;
                    }
                });
                
                // Verificar productos en localStorage
                const productos = JSON.parse(localStorage.getItem('productos') || '[]');
                estadoHTML += `<span class="text-info">📦 Productos en localStorage: ${productos.length}</span><br>`;
                
                estadoInfo.className = 'alert alert-success';
            } else {
                estadoHTML += '<span class="text-danger">✗ adminDashboard NO está disponible</span><br>';
                estadoHTML += '<span class="text-warning">⚠️ El dashboard no se ha inicializado correctamente</span>';
                estadoInfo.className = 'alert alert-danger';
            }
            
            estadoInfo.innerHTML = estadoHTML;
            console.log('Estado del dashboard verificado:', {
                adminDashboard: window.adminDashboard,
                metodos: window.adminDashboard ? {
                    editarProducto: typeof window.adminDashboard.editarProducto,
                    eliminarProducto: typeof window.adminDashboard.eliminarProducto,
                    loadProductos: typeof window.adminDashboard.loadProductos
                } : 'No disponible'
            });
        }
        
        // Función para cargar producto de prueba
        function cargarProductoPrueba() {
            localStorage.setItem('productos', JSON.stringify([productoPrueba]));
            mostrarProductos();
            console.log('Producto de prueba cargado:', productoPrueba);
            alert('Producto de prueba cargado exitosamente');
            verificarEstado();
        }
        
        // Función para mostrar productos en la tabla
        function mostrarProductos() {
            const productos = JSON.parse(localStorage.getItem('productos') || '[]');
            const tbody = document.getElementById('productosTable');
            tbody.innerHTML = '';
            
            productos.forEach(producto => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${producto.codigo}</td>
                    <td>${producto.nombre}</td>
                    <td>$${producto.precio}</td>
                    <td>${producto.stock}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editarProducto('${producto.id}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Función para probar edición
        function probarEdicion() {
            const productos = JSON.parse(localStorage.getItem('productos') || '[]');
            if (productos.length === 0) {
                alert('Primero carga un producto de prueba');
                return;
            }
            
            console.log('Probando función editarProducto...');
            const primerProducto = productos[0];
            editarProducto(primerProducto.id);
        }
        
        // Función para generar vista previa del QR
        function generarVistaPreviaQR(texto) {
            const qrPreview = document.getElementById('qrPreview');
            if (!qrPreview) {
                return;
            }
            
            if (!texto) {
                texto = 'PROD-' + Date.now();
            }
            
            qrPreview.innerHTML = '';
            
            try {
                if (typeof QRCode === 'undefined') {
                    qrPreview.innerHTML = '<small class="text-warning">Librería QR no disponible</small>';
                    return;
                }
                
                QRCode.toDataURL(texto, {
                    width: 120,
                    height: 120,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                }, (error, url) => {
                    if (error) {
                        console.error('Error generando QR:', error);
                        qrPreview.innerHTML = '<small class="text-danger">Error al generar QR</small>';
                    } else {
                        const img = document.createElement('img');
                        img.src = url;
                        img.alt = 'Código QR';
                        img.style.maxWidth = '100%';
                        img.style.height = 'auto';
                        qrPreview.appendChild(img);
                    }
                });
            } catch (error) {
                console.error('Error en generarVistaPreviaQR:', error);
                qrPreview.innerHTML = '<small class="text-danger">Error al generar QR</small>';
            }
        }
        
        // Función para guardar producto (placeholder)
        function guardarProducto() {
            alert('Función de guardar producto no implementada en esta prueba');
        }
        
        // Inicializar la página
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Página de prueba de inicialización cargada');
            
            // Esperar un poco para que el dashboard se inicialice
            setTimeout(() => {
                verificarEstado();
                mostrarProductos();
            }, 500);
        });
    </script>
</body>
</html>
