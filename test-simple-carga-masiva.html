<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Simple Carga Masiva</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>Test Simple - Carga Masiva</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Pruebas Básicas</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-2" onclick="testDescargarProductos()">
                            <i class="fas fa-download"></i> Descargar Formato Productos
                        </button>
                        
                        <button class="btn btn-info mb-2" onclick="testDescargarProveedores()">
                            <i class="fas fa-download"></i> Descargar Formato Proveedores
                        </button>
                        
                        <button class="btn btn-success mb-2" onclick="testCargarProductos()">
                            <i class="fas fa-upload"></i> Probar Carga Productos
                        </button>
                        
                        <button class="btn btn-warning mb-2" onclick="testCargarProveedores()">
                            <i class="fas fa-upload"></i> Probar Carga Proveedores
                        </button>
                        
                        <hr>
                        
                        <button class="btn btn-danger" onclick="reinicializarSistema()">
                            <i class="fas fa-redo"></i> Reinicializar Sistema
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Estado del Sistema</h5>
                    </div>
                    <div class="card-body">
                        <div id="estadoSistema">
                            <div class="alert alert-info">
                                <i class="fas fa-spinner fa-spin"></i> Verificando...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/admin-dashboard.js"></script>
    
    <script>
        let adminDashboard = null;
        
        function mostrarNotificacion(mensaje, tipo = 'info') {
            if (adminDashboard && typeof adminDashboard.showNotification === 'function') {
                adminDashboard.showNotification(mensaje, tipo);
            } else {
                alert(mensaje);
            }
        }
        
        function actualizarEstado() {
            const estadoDiv = document.getElementById('estadoSistema');
            
            if (!adminDashboard) {
                estadoDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle"></i> 
                        <strong>Error:</strong> Dashboard no inicializado
                    </div>
                `;
                return;
            }
            
            const metodosRequeridos = [
                'cargarProductosMasivo',
                'cargarProveedoresMasivo',
                'descargarFormatoProductos',
                'descargarFormatoProveedores',
                'showNotification'
            ];
            
            const metodosDisponibles = metodosRequeridos.filter(metodo => 
                typeof adminDashboard[metodo] === 'function'
            );
            
            if (metodosDisponibles.length === metodosRequeridos.length) {
                estadoDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> 
                        <strong>Éxito:</strong> Sistema funcionando
                        <br><small>Métodos: ${metodosDisponibles.length}/${metodosRequeridos.length}</small>
                    </div>
                `;
            } else {
                estadoDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>Advertencia:</strong> Algunos métodos faltan
                        <br><small>Métodos: ${metodosDisponibles.length}/${metodosRequeridos.length}</small>
                    </div>
                `;
            }
        }
        
        function inicializarDashboard() {
            try {
                console.log('Inicializando dashboard...');
                adminDashboard = new AdminDashboard();
                window.adminDashboard = adminDashboard;
                console.log('Dashboard inicializado:', adminDashboard);
                actualizarEstado();
                return true;
            } catch (error) {
                console.error('Error al inicializar:', error);
                actualizarEstado();
                return false;
            }
        }
        
        function testDescargarProductos() {
            console.log('Probando descarga de productos...');
            
            if (!adminDashboard) {
                alert('Dashboard no inicializado');
                return;
            }
            
            try {
                // Crear contenido CSV directamente
                const csvContent = `sep=;
codigo;nombre;descripcion;codigoQR;precio;descuentoMinimo;descuentoMaximo;stock;stockMinimo;stockMaximo;estado;proveedor
PROD001;Aceite de Motor 4T;Aceite sintético para motos 4T 1L;PROD001;15.50;0.00;0.00;50;5;100;Activo;Aceites Pro
PROD002;Filtro de Aire;Filtro de aire de alta calidad universal;PROD002;8.75;0.00;0.00;30;5;100;Activo;Filtros Max`;
                
                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'test_productos.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                mostrarNotificacion('Archivo de prueba descargado exitosamente', 'success');
            } catch (error) {
                console.error('Error:', error);
                alert('Error al descargar: ' + error.message);
            }
        }
        
        function testDescargarProveedores() {
            console.log('Probando descarga de proveedores...');
            
            if (!adminDashboard) {
                alert('Dashboard no inicializado');
                return;
            }
            
            try {
                // Crear contenido CSV directamente
                const csvContent = `sep=;
ruc;nombre;direccion;telefono;email
1234567890001;Aceites Pro;Av. Principal 123, Quito;02-234-5678;info@aceitespro.com
1234567890002;Filtros Max;Calle Comercial 456, Guayaquil;04-345-6789;ventas@filtrosmax.com`;
                
                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'test_proveedores.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                mostrarNotificacion('Archivo de prueba descargado exitosamente', 'success');
            } catch (error) {
                console.error('Error:', error);
                alert('Error al descargar: ' + error.message);
            }
        }
        
        function testCargarProductos() {
            console.log('Probando carga de productos...');
            
            if (!adminDashboard) {
                alert('Dashboard no inicializado');
                return;
            }
            
            if (typeof adminDashboard.cargarProductosMasivo === 'function') {
                try {
                    adminDashboard.cargarProductosMasivo();
                    mostrarNotificacion('Función de carga de productos ejecutada', 'success');
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al cargar productos: ' + error.message);
                }
            } else {
                alert('Función de carga de productos no disponible');
            }
        }
        
        function testCargarProveedores() {
            console.log('Probando carga de proveedores...');
            
            if (!adminDashboard) {
                alert('Dashboard no inicializado');
                return;
            }
            
            if (typeof adminDashboard.cargarProveedoresMasivo === 'function') {
                try {
                    adminDashboard.cargarProveedoresMasivo();
                    mostrarNotificacion('Función de carga de proveedores ejecutada', 'success');
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al cargar proveedores: ' + error.message);
                }
            } else {
                alert('Función de carga de proveedores no disponible');
            }
        }
        
        function reinicializarSistema() {
            console.log('Reinicializando sistema...');
            adminDashboard = null;
            window.adminDashboard = null;
            
            if (inicializarDashboard()) {
                mostrarNotificacion('Sistema reinicializado correctamente', 'success');
            } else {
                mostrarNotificacion('Error al reinicializar', 'danger');
            }
        }
        
        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM cargado, inicializando...');
            inicializarDashboard();
        });
    </script>
</body>
</html>
